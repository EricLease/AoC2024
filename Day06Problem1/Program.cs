using System.Drawing;

const bool debug = false;

/* 
    #: obstruction
    ^: guard facing "up" (from the perspective of the map)

    Rule: move forward unless obstructed, then turn right 90
    Find the number of distinct positions the guard will cover before leaving the area.

    Ex. from starting input

    ....#.....
    .........#
    ..........
    ..#.......
    .......#..
    ..........
    .#..^.....
    ........#.
    #.........
    ......#...
    
    ------------------------

    ....#.....
    ....^....#
    ..........
    ..#.......
    .......#..
    ..........
    .#........
    ........#.
    #.........
    ......#...
    
    ------------------------

    ....#.....
    ........>#
    ..........
    ..#.......
    .......#..
    ..........
    .#........
    ........#.
    #.........
    ......#...
    
    ------------------------

    ....#.....
    .........#
    ..........
    ..#.......
    .......#..
    ..........
    .#......v.
    ........#.
    #.........
    ......#...

    ...eventually...
    
    ....#.....
    .........#
    ..........
    ..#.......
    .......#..
    ..........
    .#........
    ........#.
    #.........
    ......#v..

    having traversed 41 distinct positions:

    ....#.....
    ....XXXXX#
    ....X...X.
    ..#.X...X.
    ..XXXXX#X.
    ..X.X.X.X.
    .#XXXXXXX.
    .XXXXXXX#.
    #XXXXXXX..
    ......#X..

    41 is the answer to the puzzle.
*/

// Expect debug ? 41 : 5318
const string _puzzleInput =
    debug ? 
    """
    ....#.....
    .........#
    ..........
    ..#.......
    .......#..
    ..........
    .#..^.....
    ........#.
    #.........
    ......#...
    """ :
    """
    .....................#................#...#.....#.................................................#...........#...................
    .............#....#.#.................................#....................................................#.........#............
    ...........................................#...................................................................#......#...........
    ....................................................#................#.......#.............#......................................
    ..........................................#...##.#....................................#....#.........#............................
    ....................................#.............................................#.......#................#.......###............
    ..##.......#......................#..#........................................................#...................#...............
    .....#...........#..................................#..............#...........#..................................................
    ..........#..#......#.....#..#........#..................#.............................#...........................##............#
    ..............................#....#..........#...................................................................................
    .......#.#..........................#.........#...##..........................................................#.#....#...#.#......
    ..............................................................................................................#.........#.........
    ....................#......#.....#...............................#..#.........#........................#.#.....#..................
    ......................................##.................#.....................#............#.#.#..............#...............#..
    #...........................#..................#.....#..#..#.............#......#.........#........#........#.#.#.................
    .......#.............#....................#.................#...#.........#.......#................#......#................#....#.
    ...............#.................................................#................#..................#..................#.........
    .........#....................#..............................#..............#..............#.......#....................#......#..
    ....................................##.............................................................................#.#............
    .....................................................................#...#.#........................#....#....#......#............
    .....#...........................#.........#.............................................................................#........
    ...............#.#.........#...............##..............................................#............#.........................
    #..............#....##....#............#...#.#............................#...................................#..#..............#.
    ........#.........#...........................................................#..............................................#....
    .........................................................................................#.......#................................
    ................................#.........#..........#..#.......................................#..............................#..
    ........................#.................................................................................##........#.............
    .....#.....................#.....................#...#...........#.........................#......................................
    ....................................................................................................#.............................
    .........#...................................#...#................................................................................
    ..............#............##......#..............#......................................................#.....................#..
    ..#.......#............................................................................#...#.....................#................
    ..................#.....................##..#.................#..........#.....#........#.............#............#...........#..
    ...................................#.....#..............#..#.............................................#.....#......#....#......
    ......#....#.....................................................#................#...............................#...............
    ..#.#..................#.......#......#.............#.......#.....................................................................
    ......##...........................#.................#.....#........................................#.............................
    ...#......................#...............##......#.......................#..........#.................#.......#.......#..........
    ...........................#.............................................................#.#................#......#..#...........
    ..#.............#.....#.........................................................#..........#......................................
    ...........#.........#..........................................................................#..............#..................
    .#.......................................................#.#.......#............................................#.#...............
    ..........................#....#...............#............................................................#.........#...........
    .........................##.........#^.....................................................#......................................
    ........#.......#.................................................................................................#.......#.......
    ..........#..................................##..#.......................#.................#....................................#.
    ...................................#..#.....#.#.............#.....#.................##..............#.............................
    ...........................................................#.........................................................#......#.....
    ............#.........................#.........#.................................................................................
    ................#.........................#...............................#.......................................................
    .....................#.......#.................#.#..............#...............#.................................................
    ...#......................#...............................#.......#.......#..........................................#............
    .........#..#............................................................................................#........................
    ..............................................................................................#.#...........#.........#...........
    ..#..............#...............#.................................................................#.....#........................
    ................#..........#.......##..............#..............................#.##......#.....................................
    .........#....#.#..................................................................#...................#..........................
    #...#............#...............................................................................................................#
    ........#.....#.#................#.........................#.........#...........................##........................#.#....
    ......#...#.....................................................................#...........................#.....................
    ........#.........#.....................#............................................................................#..........#.
    .................................................................#....................#.........#..#...#.##.......................
    ..........#...........................##.......#...................................................................#.#............
    .......................................................................................#.................#..#.#...................
    ............................................................................................#.............#.......................
    ........................#........................#.................#..........................#...........................#.......
    .....................................#......#.................................#..........#........................................
    ....#...............................#........#............................#............................#..........................
    ..........#................#.#....................................................................................................
    #........................................................................#..........................................#.....#.......
    .#....................................#.........#..#.#...................................................#........................
    ...................#....................#..............#..................#.................................................#.....
    .........................................................................#..........................#............#................
    ........................................................#.................................................................#.......
    #...........................................#..............#............................................................#..#......
    ...............#..............#...............#............................#.......#.............#....#...........................
    ......#............#.#...........................................................................................#................
    ..................#..#.......#..............................#.............................#........#.......#.........#...........#
    ...............#.....................................#......#....................................#..........#................#....
    .............................................#...............#...........#........#.............#...#.......................##....
    .....#..................#...........#..............#.............#....................................#.........#.................
    ........................#.......................................................................#...........#.....................
    .............................#.....................................................#........##....................................
    ...........#.................................................................................#.........#....#....#.....#..........
    .....#..................................................................................#.....#.............................#....#
    ..#........#...............#.........................................................#.......#........................#.........#.
    ..............................................#....................##..............................#..........#.......#.#......#..
    .......................#......................................................#........#..........................................
    ..#.........................................#...........#.........................................................#...............
    ..........................#.......#...............................................................................................
    .........#.....................#..............................................#...............#...................................
    ..............................................#.........#..........#....#..............#..........................................
    ......................................#.........#............#........................................................#...#.......
    ...........................................#.....#..................#.....#..........#...............#...#........................
    .......................#........#..........................................................#.......#.........#............#....#..
    ..........#.....................................................................#...#.......#.......#.........#.....#.............
    .............................#..#...............................#....#.................................................#..#.......
    .#.............#................##......................................#...#..............................#............#.........
    ....#.........#....#..................................................................................#...............#.....#.....
    ......#................................................#.....#.#.......#.......#....................#.............#...............
    ...............................#..........#........................#.......................................................#.....#
    ...............#.......................................................................................#......#.......#..#.#.#....
    ..#....#.........................................................................#...................#....................##......
    ...........................#......#.................#...#..........................#..............................................
    ......#..........#...#............#....#..........................................................................................
    .......................#......#...............#..#......................#......#........................#........................#
    .#............#................................#............#....................#.................................#..............
    ................#.........#.................###............#..#...............#..............................#...#................
    ......#..........................#....#............#.................#...................................................#........
    ..........................#...#.............#........#......................#......................#.#.............#............#.
    ............................#................#....................#....##.......................#........#..........##.....#......
    ..............#.#...................#.#.............................................#..........#......#...........................
    .....#.........................#...........#...#......................................#......#..........#.#....#.##...............
    .............##.##....................................................................#.#..............#.......#.....#..#...#.....
    #.......#..................#.........#...................#................#..##...............##...............#..................
    ..............#....#........#.....#.................................#....#....#...#.......................................#.......
    ...........................#......#..............................#......................#.........................................
    .................#.#..........##................#...#..................................#..............#.....#.................#...
    ..........................#..............#..#......................#.......................#...........##.........................
    ..#...................#..........#.......#..........#...............................#.....................#.......................
    ............#......................#................#....#......................#.................................................
    ...........................................#........#.........#..........#..................#....#.........#....##................
    ..........#........................#.#...............#............................................#........#...#.....#............
    ...............#..........#..........#...#.....#........................#..............#..#.....................##................
    ...#.......................##.....................#................................................#..#............#..............
    ....#........#..#...#.#............................#................#................#............................................
    ...........#....................#.....#.........................#....................#.............#....#.........#...#........##.
    .#.....#.................##............#...............................#...............#.......................##.................
    ..............................#................................#.............................#................#.#.................
    ............##..............#........#.......#...................#..........................#.............###..#...#............#.
    """;

static List<string> GetLines()
    => [.._puzzleInput.Split(
        Environment.NewLine,
        StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)];

static bool GuardPresent(Point position, int width, int height)
    => position.X >= 0 && position.X < width &&
       position.Y >= 0 && position.Y < height;

static Point GetDirectionalOffset(Point position, MapDirections direction) => direction switch
{
    MapDirections.Up => new Point(position.X, position.Y - 1),
    MapDirections.Right => new Point(position.X + 1, position.Y),
    MapDirections.Down => new Point(position.X, position.Y + 1),
    MapDirections.Left => new Point(position.X - 1, position.Y),
    _ => throw new NotImplementedException(),
};

static void PrintMap(
    int width, int height, 
    List<Point> obstructions, 
    Point guard, MapDirections guardDirection, 
    HashSet<Point> uniqueLocations,
    bool full = false)
{
    Console.BackgroundColor = ConsoleColor.DarkBlue;
    Console.Clear();

    var startingRow = full ? 0 : Math.Max(0, guard.Y - 25);
    var maxRow = full ? height : Math.Min(height, guard.Y + 25);

    for (var row = startingRow; row < maxRow; row++)
    {
        for (var col = 0; col < width; col++)
        {
            var point = new Point(col, row);

            if (obstructions.Contains(point))
            {
                Console.BackgroundColor = ConsoleColor.Red;
                Console.Write('#');
                continue;
            }

            if (point == guard)
            {
                Console.BackgroundColor = ConsoleColor.Green;
                Console.Write(
                    guardDirection switch
                    {
                        MapDirections.Up => '^',
                        MapDirections.Right => '>',
                        MapDirections.Down => 'v',
                        MapDirections.Left => '<',
                        _ => '@',
                    });
                continue;
            }

            if (uniqueLocations.Contains(point))
            {
                Console.BackgroundColor = ConsoleColor.Blue;
                Console.Write('X');
                continue;
            }

            Console.BackgroundColor = ConsoleColor.Black;
            Console.Write('.');
        }

        Console.BackgroundColor = ConsoleColor.DarkBlue;
        Console.WriteLine();
    }

    Console.WriteLine("\n\n");
    Console.WriteLine($"Unique Locations: {uniqueLocations.Count}");
}

var lines = GetLines();
var height = lines.Count;
var width = lines[0].Length;
var obstructions = new List<Point>();
var uniqueLocations = new HashSet<Point>();
var guardDirection = MapDirections.Up;
Point? guard = null;

for (var row = 0; row < height; row++)
{
    var line = lines[row];

    for (var col = 0; col < width; col++)
    {
        switch (line[col])
        {
            case '#':
                obstructions.Add(new(col, row));
                break;

            case '^':
                guard = new Point(col, row);
                break;
        }
    }
}

if (guard == null) throw new Exception("Malformed input");

do
{
    uniqueLocations.Add(guard.Value);

    Point? testPoint = null;
    var directionsTried = 0;
    var numDirections = Enum.GetValues<MapDirections>().Length;

    while (directionsTried++ < numDirections)
    {
        testPoint = GetDirectionalOffset(guard.Value, guardDirection);

        if (!obstructions.Contains(testPoint.Value)) break;

        guardDirection = TurnRight(guardDirection);
    }

    guard = testPoint;
} while (GuardPresent(guard!.Value, width, height));

static MapDirections TurnRight(MapDirections direction) => (MapDirections)(((int)direction + 1) % 4);

var lastGuardPosition = GetDirectionalOffset(guard.Value, TurnRight(TurnRight(guardDirection)));

PrintMap(width, height, obstructions, lastGuardPosition, guardDirection, uniqueLocations, true);

internal enum MapDirections
{
    // In this order to mirror clockwise rotation
    Up,
    Right,
    Down,
    Left
}